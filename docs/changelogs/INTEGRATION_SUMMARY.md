# USGS Spectral Library Integration Summary

## Overview
The USGS spectral library loader has been successfully integrated into the main `hyperion_workflow.py` workflow script.

## What Was Done

### 1. Created Standalone Module: `load_usgs_spectrum.py`
**Location:** `amd_mapping/code/load_usgs_spectrum.py`

**Features:**
- Loads USGS Hyperion-format spectral data
- Automatically handles wavelength file loading
- Configurable mineral list via `MINERALS_TO_LOAD`
- Case-insensitive file search
- Compatible with Python 3.5+ (no f-strings)
- No pandas dependency (uses pure NumPy)

**Key Functions:**
- `load_minerals_spectra()`: Main function to load multiple minerals
- `load_hyperion_wavelengths()`: Loads wavelength data
- `find_mineral_file()`: Smart mineral file search

### 2. Integrated into Main Workflow: `hyperion_workflow.py`
**Location:** `PROCESSING_AND_POST/hyperion_workflow.py`

**Changes Made:**
- Added module import at the top (lines 37-46)
- Modified `download_usgs_library()` to use the new loader
- Enhanced `create_endmember_library()` to support both:
  - **Automatic loading** (USGS loader - preferred)
  - **Manual loading** (fallback for custom libraries)
- Updated `main_workflow()` to use the new functionality

### 3. Test Suite: `test_integration.py`
**Location:** `PROCESSING_AND_POST/test_integration.py`

Successfully tests:
- Module imports
- Mineral loading
- Endmember library creation
- File output generation

## How to Use

### Quick Start (Recommended)
```python
from hyperion_workflow import create_endmember_library

# Load USGS minerals automatically
endmembers, wavelengths = create_endmember_library(
    output_file='./amd_mapping/data/outputs/endmember_library.sli'
)
```

### Customize Minerals
Edit `amd_mapping/code/load_usgs_spectrum.py`:
```python
MINERALS_TO_LOAD = [
    'Jarosite',
    'Goethite',
    'YourMineral',  # Add or remove minerals here
]
```

### Run Full Workflow
```python
from hyperion_workflow import main_workflow

# Run complete AMD mapping workflow
main_workflow()
```

### Standalone Usage
```python
import sys
sys.path.append('./amd_mapping/code')
from load_usgs_spectrum import load_minerals_spectra

# Load minerals
spectra = load_minerals_spectra()

# Access individual mineral
wavelengths, reflectance = spectra['Jarosite']
```

## Outputs

### Generated Files
1. **CSV Format:** `test_endmember_library.csv`
   - Human-readable format
   - Columns = minerals, Rows = wavelengths
   - Easy to import into Excel/Python

2. **ENVI Library:** `test_endmember_library.sli` + `.hdr`
   - Industry-standard format
   - Compatible with ENVI, SNAP, QGIS
   - Ready for SAM/MTMF analysis

3. **Visualization:** `minerals_spectra.png`
   - Plot of all mineral spectra
   - Generated by standalone script

### Data Specifications
- **Bands:** 242 (Hyperion wavelengths)
- **Wavelength Range:** 355.6 - 2577.1 nm
- **Format:** Reflectance values (0-1)
- **Minerals Loaded:** 8 (Jarosite, Goethite, Hematite, Kaolinite, Alunite, Illite, Smectite, Gypsum)

## File Structure
```
PROCESSING_AND_POST/
├── hyperion_workflow.py          # Main workflow (modified)
├── test_integration.py            # Integration tests
└── amd_mapping/
    ├── code/
    │   └── load_usgs_spectrum.py  # USGS loader module
    └── data/
        └── outputs/
            ├── minerals_spectra.png
            ├── test_endmember_library.csv
            ├── test_endmember_library.sli
            └── test_endmember_library.sli.hdr
```

## Advantages of This Integration

### Modular Design
- Standalone module can be used independently
- Easy to maintain and update
- No breaking changes to existing workflow

### Flexibility
- Automatic USGS loading (preferred)
- Fallback to manual loading
- Easy to add custom mineral sources

### Ready for Analysis
- Direct compatibility with SAM (Spectral Angle Mapper)
- Works with MTMF (Mixture Tuned Matched Filter)
- ENVI-compatible output format

### Extensibility
- Easy to add more minerals
- Can integrate other spectral libraries
- Compatible with resampling functions

## Next Steps

### For Your Workflow
1. **Add your Hyperion image:**
   - Place preprocessed image as `hyperion_cube.hdr`
   - Run `main_workflow()` to execute full pipeline

2. **Customize minerals:**
   - Edit `MINERALS_TO_LOAD` in `load_usgs_spectrum.py`
   - Add AMD-specific minerals as needed

3. **Run SAM classification:**
   - Workflow automatically uses loaded endmembers
   - Outputs mineral classification maps

### Optional Enhancements
- Add spectral resampling to match your specific Hyperion bands
- Integrate continuum removal
- Add validation against field data

## Testing

Run the integration test:
```bash
cd PROCESSING_AND_POST
python test_integration.py
```

Expected output:
- ✓ All 8 minerals loaded
- ✓ 242 wavelength bands
- ✓ CSV and ENVI files created
- ✓ No errors

## Notes

- **Python Version:** Works with Python 3.5+ (tested with Anaconda)
- **Dependencies:** NumPy, matplotlib, pathlib
- **Data Source:** USGS Spectral Library v7 (Hyperion resampled)
- **License:** Follow USGS data usage terms

## Contact
For issues or questions, refer to the code comments or documentation in the main workflow file.
